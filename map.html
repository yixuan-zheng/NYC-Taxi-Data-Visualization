<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NYC Taxi Hotspots — Time-Weighted Clusters (Spatiotemporal)</title>
<style>
  :root {
    --page:#f8fafc;
    --panel:#ffffff;
    --ink:#0f172a;
    --muted:#64748b;
    --map:#ffffff;
  }
  html,body{
    height:100%;
    margin:0;
    background:var(--page);
    color:var(--ink);
    font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  .wrap{
    display:grid;
    grid-template-columns:360px 1fr;
    gap:12px;
    height:100%;
    padding:12px;
    box-sizing:border-box;
  }
  .panel{
    background:var(--panel);
    border-radius:14px;
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:12px;
    box-shadow:0 10px 25px rgba(15,23,42,.05);
  }
  .panel h2{margin:0 0 6px 0;font-size:16px}
  .controls{display:grid;gap:10px}
  .row{display:flex;gap:10px;align-items:center}
  input[type="range"]{width:100%}
  .map{
    position:relative;
    border-radius:14px;
    overflow:hidden;
    background:var(--map);
    box-shadow:0 16px 40px rgba(15,23,42,.05), 0 0 0 1px rgba(148,163,184,.25);
  }
  .tooltip{
    position:absolute;
    pointer-events:none;
    background:#ffffff;
    color:#0f172a;
    padding:8px 10px;
    border-radius:8px;
    font-size:12px;
    box-shadow:0 8px 20px rgba(15,23,42,.18);
    opacity:0;
    border:1px solid rgba(148,163,184,.3);
  }
  .muted{color:var(--muted);font-size:12px}
  .legend-box{
    background:#f1f5f9;
    border:1px solid rgba(148,163,184,.35);
    border-radius:10px;
    padding:8px 10px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .legend-bar{
    height:10px;
    border-radius:9999px;
    background:linear-gradient(to right, #ffffcc, #fed976, #fd8d3c, #e31a1c);
  }
  .legend-labels{
    display:flex;
    justify-content:space-between;
    font-size:11px;
    color:#475569;
  }
</style>

<div class="wrap">
  <div class="panel">
    <h2>NYC Taxi Hotspots — Time-Weighted Clusters</h2>
    <div class="muted">Spatiotemporal DBSCAN — intensity by hour.</div>
    <div class="controls">
      <div class="row">
        <label for="hour">Hour</label>
        <input id="hour" type="range" min="0" max="23" value="8" step="1" />
        <span id="hourLabel">08:00</span>
      </div>
    </div>
    <div class="muted">Fill = trips at the selected hour. Black stroke = zone; red stroke = noise (cluster_id = -1). Hover for details.</div>
    <div id="stats" class="muted"></div>
    <div class="legend-box">
      <div style="font-weight:600;font-size:12px;">Trips/hour</div>
      <div class="legend-bar"></div>
      <div class="legend-labels">
        <span id="legendStart">0</span>
        <span id="legendMid">—</span>
        <span id="legendEnd">—</span>
      </div>
      <div class="muted" id="legendNote">Scaled to selected dataset.</div>
    </div>
    <div style="margin-top:auto" class="muted">Data: clusters_spatiotemporal.csv</div>
  </div>
  <div class="map">
    <svg id="svg" width="100%" height="100%"></svg>
    <div class="tooltip" id="tip"></div>
  </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
(async function() {
  const mapEl = document.querySelector(".map");
  const width = mapEl.clientWidth;
  const height = mapEl.clientHeight || window.innerHeight - 24;

  const svg = d3.select("#svg")
    .attr("viewBox", [0,0,width,height]);

  // zoom root
  const gRoot = svg.append("g").attr("class","root");
  const gZones = gRoot.append("g");

  // zoom / pan
  const zoom = d3.zoom()
    .scaleExtent([1, 6])
    .on("zoom", (event) => {
      gRoot.attr("transform", event.transform);
    });
  svg.call(zoom);

  // load data
  const zones = await d3.json("data/taxi_zones.geojson");
  const st = await d3.csv("data/clusters_spatiotemporal.csv", d3.autoType);

  function prop(o, ...names) {
    for (const n of names) if (o && o[n] != null) return o[n];
    return undefined;
  }
  function fmtHour(h){ return `${h.toString().padStart(2,"0")}:00`; }

  const stKey = (loc, h) => `${loc}|${h}`;
  const stByKey = new Map(st.map(d => [stKey(d.LocationID, d.hour), d]));

  const projection = d3.geoMercator().fitSize([width, height], zones);
  const path = d3.geoPath(projection);

  // keep original quantized color logic
  const maxIntensityHour = d3.max(st, d => d.intensity_hour) || 1;
  const color = d3.scaleQuantize()
    .domain([0, maxIntensityHour])
    .range(d3.schemeYlOrRd[7].slice(1));

  // legend labels (0, mid, max) rounded
  const startVal = 0;
  const midVal = Math.round(maxIntensityHour / 2 / 1000) * 1000;
  const endVal = Math.round(maxIntensityHour / 1000) * 1000;
  document.getElementById("legendStart").textContent = startVal.toLocaleString();
  document.getElementById("legendMid").textContent = midVal.toLocaleString();
  document.getElementById("legendEnd").textContent = endVal.toLocaleString();
  document.getElementById("legendNote").textContent = `0 → ${endVal.toLocaleString()} trips/hour`;

  const tip = d3.select("#tip");

  const zonesSel = gZones.selectAll("path.zone").data(zones.features).join("path")
    .attr("class","zone")
    .attr("d", path)
    .attr("stroke", "#000")
    .attr("stroke-width", 0.6);

  function repaint() {
    const hour = +document.getElementById("hour").value;
    document.getElementById("hourLabel").textContent = fmtHour(hour);

    zonesSel
      .attr("fill", d => {
        const id = +d.properties.LocationID;
        const row = stByKey.get(`${id}|${hour}`);
        const val = row ? +row.intensity_hour : 0;
        return color(val);
      })
      .attr("fill-opacity", 0.95)
      .attr("stroke", d => {
        const id = +d.properties.LocationID;
        const row = stByKey.get(`${id}|${hour}`);
        return row && +row.cluster_id === -1 ? "#dc2626" : "#000";
      })
      .on("mousemove", (event, d) => {
        const hour = +document.getElementById("hour").value;
        const id = +d.properties.LocationID;
        const row = stByKey.get(`${id}|${hour}`);

        // highlight this zone, dim others
        zonesSel
          .attr("fill-opacity", z => (z === d ? 1 : 0.18))
          .attr("stroke-width", z => (z === d ? 1.3 : 0.6));

        const zoneName = prop(d.properties, "Zone","zone","ZONE","name");
        const borough  = prop(d.properties, "Borough","borough","BOROUGH","boro","BoroName","boro_name");

        let html = `<div><b>${zoneName ?? "Unknown zone"}</b>${borough ? " — " + borough : ""}</div>`;
        html += `<div>Hour: ${fmtHour(hour)}</div>`;
        // we removed the "Cluster: ..." line per earlier note
        html += `<div>Trips (this hour): ${row ? (+row.intensity_hour).toLocaleString() : 0}</div>`;
        html += `<div>Avg fare (this hour): ${row && isFinite(+row.avg_fare_hour) ? "$"+(+row.avg_fare_hour).toFixed(2) : "—"}</div>`;
        html += `<div>Avg duration (this hour): ${row && isFinite(+row.avg_duration_min_hour) ? (+row.avg_duration_min_hour).toFixed(1)+" min" : "—"}</div>`;

        tip.style("opacity", 1)
          .style("left", (event.offsetX + 12) + "px")
          .style("top",  (event.offsetY + 12) + "px")
          .html(html);
      })
      .on("mouseleave", () => {
        // reset dimming
        zonesSel
          .attr("fill-opacity", 0.95)
          .attr("stroke-width", 0.6);
        tip.style("opacity", 0);
      });

    d3.select("#stats").text(`Spatiotemporal • Hour: ${fmtHour(hour)} • Max intensity: ${maxIntensityHour.toLocaleString()} trips/hour`);
  }

  repaint();
  d3.select("#hour").on("input", repaint);
})();
</script>

<!-- keep external hour setter -->
<script>
window.addEventListener('message', (event) => {
  const { type, value } = event.data || {};
  if (type === 'setHour') {
    const hourInput = document.getElementById('hour');
    if (hourInput) {
      hourInput.value = value;
      hourInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
  }
});
</script>
</html>